<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpectraLens ‚Äî Free IR Spectrum Analyzer & Comparison Tool</title>
<meta name="description" content="SpectraLens is a free AI-powered IR spectrum analysis tool. Upload 2 to 400 infrared spectrum images to identify chemical compounds, compare peak patterns, and get similarity scores instantly.">
<meta name="keywords" content="IR spectrum analyzer, infrared spectroscopy tool, spectrum comparison, chemical compound identification, IR spectra similarity, FTIR analysis, peak comparison, free spectrum tool, chemistry analyzer">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://spectralens-production.up.railway.app/">
<meta property="og:title" content="SpectraLens ‚Äî Free IR Spectrum Analyzer">
<meta property="og:description" content="Upload 2 to 400 IR spectrum images. AI identifies compounds, compares peak patterns, and scores similarity. Free to use.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://spectralens-production.up.railway.app/">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"SpectraLens","description":"Free AI-powered IR spectrum analysis and comparison tool","url":"https://spectralens-production.up.railway.app/","applicationCategory":"Science","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --white:#ffffff;--off:#f7f6f3;--stone:#e8e5df;--mid:#c4bfb5;--ink:#1a1916;--ink2:#3d3a34;--ink3:#6b6760;
  --teal:#1a6b5e;--teal-l:#e8f4f1;--amber:#b85c1a;--amber-l:#fdf0e8;--red:#c0392b;--red-l:#fdf0ef;
  --green:#1a6b3a;--green-l:#e8f4ec;--border:#e0ddd6;
  --shadow:0 1px 3px rgba(26,25,22,.08),0 4px 16px rgba(26,25,22,.04);
  --shadow-lg:0 4px 6px rgba(26,25,22,.06),0 12px 40px rgba(26,25,22,.1);
  --r:10px;--mono:'DM Mono',monospace;--sans:'DM Sans',sans-serif;--serif:'Fraunces',serif;
}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--off);color:var(--ink);font-size:15px;line-height:1.6;min-height:100vh}

/* NAV */
nav{background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;height:60px;display:flex;align-items:center}
.nav-inner{max-width:1200px;margin:0 auto;width:100%;padding:0 32px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
.brand-mark{width:32px;height:32px;background:var(--ink);border-radius:8px;display:flex;align-items:center;justify-content:center}
.brand-mark svg{width:18px;height:18px}
.brand-name{font-family:var(--serif);font-size:18px;font-weight:600;letter-spacing:-.3px}
.nav-links{display:flex;gap:2px}
.nav-btn{background:none;border:none;padding:7px 14px;border-radius:7px;font-family:var(--sans);font-size:14px;font-weight:500;color:var(--ink3);cursor:pointer;transition:all .15s}
.nav-btn:hover{background:var(--off);color:var(--ink)}
.nav-btn.active{background:var(--ink);color:var(--white)}

/* LAYOUT */
.page{display:none}.page.active{display:block}
.container{max-width:1200px;margin:0 auto;padding:0 32px}

/* HERO */
.hero{padding:56px 0 40px;border-bottom:1px solid var(--border);background:var(--white)}
.hero-inner{max-width:1200px;margin:0 auto;padding:0 32px}
.hero h1{font-family:var(--serif);font-size:40px;font-weight:300;line-height:1.15;letter-spacing:-1px;max-width:600px;margin-bottom:12px}
.hero h1 em{font-style:italic;color:var(--teal)}
.hero p{color:var(--ink3);font-size:16px;max-width:480px;margin-bottom:28px}
.hero-stats{display:flex;gap:32px}
.stat{display:flex;flex-direction:column}
.stat-num{font-family:var(--mono);font-size:22px;font-weight:500;line-height:1}
.stat-label{font-size:12px;color:var(--ink3);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}

/* MAIN */
.main{padding:40px 0 80px}

/* PANEL */
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.panel-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:14px;font-weight:600;letter-spacing:-.2px}
.panel-subtitle{font-size:13px;color:var(--ink3);margin-top:2px}
.panel-body{padding:24px}

/* DROPZONE */
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:48px 24px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--off)}
.dropzone:hover,.dropzone.drag-over{border-color:var(--teal);background:var(--teal-l)}
.dropzone input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%}
.dz-icon{width:48px;height:48px;background:var(--white);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:var(--shadow)}
.dz-icon svg{width:22px;height:22px;color:var(--teal)}
.dz-title{font-size:15px;font-weight:500;margin-bottom:4px}
.dz-sub{font-size:13px;color:var(--ink3)}
.dz-sub span{color:var(--teal);font-weight:500;text-decoration:underline;text-underline-offset:2px}

/* FILE GRID */
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:16px;max-height:280px;overflow-y:auto}
.file-thumb{position:relative;border-radius:6px;overflow:hidden;border:1px solid var(--border);background:var(--white);aspect-ratio:1}
.file-thumb img{width:100%;height:100%;object-fit:cover}
.file-thumb .rm-btn{position:absolute;top:4px;right:4px;width:18px;height:18px;background:rgba(26,25,22,.7);border:none;border-radius:50%;color:white;font-size:11px;cursor:pointer;display:none;align-items:center;justify-content:center}
.file-thumb:hover .rm-btn{display:flex}
.file-count{display:inline-flex;align-items:center;gap:6px;background:var(--teal-l);color:var(--teal);border:1px solid rgba(26,107,94,.2);padding:5px 12px;border-radius:20px;font-size:13px;font-weight:500;margin-top:12px}

/* OPTIONS */
.options-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
.field label{display:block;font-size:12px;font-weight:500;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.field select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:7px;font-family:var(--sans);font-size:14px;color:var(--ink);background:var(--white);appearance:none;outline:none;transition:border .15s}
.field select:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(26,107,94,.1)}
.select-wrap{position:relative}
.select-wrap::after{content:'';position:absolute;right:12px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid var(--ink3);pointer-events:none}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;border:none;text-decoration:none}
.btn-primary{background:var(--ink);color:var(--white)}
.btn-primary:hover{background:var(--ink2);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
.btn-primary:disabled{opacity:.45;pointer-events:none}
.btn-outline{background:var(--white);color:var(--ink);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--ink3);background:var(--off)}
.btn-sm{padding:7px 14px;font-size:13px}
.action-row{display:flex;align-items:center;gap:12px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}
.pair-estimate{margin-left:auto;font-size:13px;color:var(--ink3);font-family:var(--mono)}
.pair-estimate strong{color:var(--teal)}

/* PROGRESS */
.progress-panel{margin-top:24px;display:none}
.progress-panel.show{display:block}
.progress-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.progress-label{font-size:14px;font-weight:500}
.progress-pct{font-family:var(--mono);font-size:14px;color:var(--teal)}
.progress-track{height:6px;background:var(--stone);border-radius:3px;overflow:hidden;margin-bottom:8px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--teal),#2a9d8f);border-radius:3px;transition:width .4s ease;width:0%}
.progress-sub{font-size:13px;color:var(--ink3)}

/* RESULTS */
.results-section{margin-top:32px;display:none}
.results-section.show{display:block}
.results-toolbar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.results-title{font-family:var(--serif);font-size:24px;font-weight:300;letter-spacing:-.5px;margin-right:auto}
.filter-tabs{display:flex;gap:4px;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:3px}
.filter-tab{padding:5px 12px;border-radius:6px;font-size:13px;font-weight:500;border:none;background:none;cursor:pointer;color:var(--ink3);transition:all .15s}
.filter-tab.active{background:var(--ink);color:var(--white)}

/* SUMMARY CARDS */
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.summary-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px}
.sc-num{font-family:var(--mono);font-size:28px;font-weight:500;line-height:1;margin-bottom:4px}
.sc-label{font-size:12px;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px}

/* RESULT CARDS */
.results-list{display:flex;flex-direction:column;gap:12px}
.result-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .2s}
.result-card:hover{box-shadow:var(--shadow-lg)}
.result-card-header{padding:16px 20px;display:flex;align-items:center;gap:16px;cursor:pointer;user-select:none}
.pair-names{flex:1;display:flex;align-items:center;gap:8px;font-size:14px;font-weight:500}
.cname{font-family:var(--mono);font-size:13px;color:var(--ink);background:var(--off);padding:3px 9px;border-radius:5px;border:1px solid var(--border)}
.vs-divider{font-size:11px;color:var(--mid);font-weight:500;text-transform:uppercase;letter-spacing:1px}
.score-pill{font-family:var(--mono);font-size:14px;font-weight:500;padding:4px 12px;border-radius:20px;flex-shrink:0}
.score-high{background:var(--green-l);color:var(--green)}
.score-mid{background:var(--amber-l);color:var(--amber)}
.score-low{background:var(--red-l);color:var(--red)}
.badge-same{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:3px 9px;border-radius:4px}
.badge-yes{background:var(--green-l);color:var(--green)}
.badge-no{background:var(--red-l);color:var(--red)}
.chevron{width:20px;height:20px;color:var(--mid);transition:transform .2s;flex-shrink:0}
.result-card.open .chevron{transform:rotate(180deg)}
.result-card-body{display:none;border-top:1px solid var(--border)}
.result-card.open .result-card-body{display:block}

/* DETAIL TABS */
.detail-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 20px;background:var(--off)}
.dtab{padding:11px 16px;font-size:13px;font-weight:500;color:var(--ink3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s}
.dtab:hover{color:var(--ink)}
.dtab.active{color:var(--teal);border-bottom-color:var(--teal)}
.detail-pane{display:none;padding:20px}
.detail-pane.active{display:block}

/* COLUMNS */
.col2{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* INFO BLOCK */
.info-block{background:var(--off);border:1px solid var(--border);border-radius:8px;padding:16px}
.info-block .label{font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:12px}
.compound-big{font-family:var(--serif);font-size:20px;font-weight:600;line-height:1.2;margin-bottom:4px}
.formula-big{font-family:var(--mono);font-size:16px;color:var(--teal);margin-bottom:12px}
.meta-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.chip{font-size:11px;font-family:var(--mono);padding:3px 8px;border-radius:4px;background:var(--white);border:1px solid var(--border);color:var(--ink3)}
.curve-text{font-size:13px;color:var(--ink3);line-height:1.6}

/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{border-bottom:1px solid var(--border)}
th{text-align:left;padding:9px 12px;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3)}
td{padding:9px 12px;border-bottom:1px solid var(--stone)}
tr:last-child td{border-bottom:none}
.wn{font-family:var(--mono);font-weight:500;color:var(--teal)}
.tr{font-family:var(--mono);color:var(--amber)}
.asgn{color:var(--ink3)}
tr.match-tr{background:rgba(26,107,58,.03)}
tr.nomatch-tr{background:rgba(192,57,43,.03)}

/* COMPARISON */
.comp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.comp-box{background:var(--off);border:1px solid var(--border);border-radius:8px;padding:14px 16px}
.comp-box .box-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px}
.comp-box p{font-size:13px;color:var(--ink2);line-height:1.6}
.sim-bar-wrap{margin-bottom:20px}
.sim-bar-top{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px}
.sim-bar-top .pct{font-family:var(--mono);font-weight:500;color:var(--teal)}
.sim-bar{height:8px;background:var(--stone);border-radius:4px;overflow:hidden}
.sim-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--teal),#2a9d8f)}
.sim-lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.sim-list-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.sim-list-title.pos{color:var(--green)}.sim-list-title.neg{color:var(--red)}
.sim-list{list-style:none}
.sim-list li{font-size:13px;padding:7px 10px;border-radius:6px;margin-bottom:4px;line-height:1.5}
.sim-list.pos li{background:var(--green-l);color:var(--ink2)}
.sim-list.neg li{background:var(--red-l);color:var(--ink2)}
.conclusion-box{background:var(--off);border-left:3px solid var(--teal);padding:14px 16px;border-radius:0 6px 6px 0;font-size:14px;color:var(--ink2);line-height:1.7}
.conclusion-box .clabel{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--teal);margin-bottom:6px}

/* REGIONS */
.regions-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.region-card{background:var(--white);border:1px solid var(--border);border-radius:7px;padding:12px}
.region-label{font-family:var(--mono);font-size:11px;color:var(--teal);margin-bottom:5px;font-weight:500}
.region-text{font-size:12px;color:var(--ink3);line-height:1.5}

/* CHART */
.chart-panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:24px}
.chart-title{font-size:15px;font-weight:600;margin-bottom:4px}
.chart-sub{font-size:13px;color:var(--ink3);margin-bottom:20px}
.chart-container{position:relative;height:320px;width:100%}
.chart-legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.legend-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--ink3)}
.legend-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}

/* HISTORY */
.history-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.history-title{font-family:var(--serif);font-size:28px;font-weight:300;letter-spacing:-.5px}
.history-table-wrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;overflow-x:auto}
.htable{width:100%;border-collapse:collapse;min-width:700px;font-size:13px}
.htable th{background:var(--off);padding:11px 14px;text-align:left;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);border-bottom:1px solid var(--border)}
.htable td{padding:11px 14px;border-bottom:1px solid var(--stone)}
.htable tr:last-child td{border-bottom:none}
.htable tr:hover td{background:var(--off)}
.score-cell{font-family:var(--mono);font-weight:500}
.score-h{color:var(--green)}.score-m{color:var(--amber)}.score-l{color:var(--red)}

/* EMPTY / ERROR */
.empty-state{text-align:center;padding:80px 20px}
.empty-icon{font-size:40px;margin-bottom:12px}
.empty-title{font-family:var(--serif);font-size:20px;font-weight:300;margin-bottom:6px}
.empty-sub{font-size:14px;color:var(--ink3)}
.error-banner{background:var(--red-l);border:1px solid rgba(192,57,43,.25);border-radius:8px;padding:14px 16px;font-size:13px;color:var(--red);margin-top:16px;display:none}

/* RESPONSIVE */
@media(max-width:768px){
  .container,.hero-inner,.nav-inner{padding:0 16px}
  .summary-grid{grid-template-columns:repeat(2,1fr)}
  .col2,.comp-grid,.sim-lists,.options-row{grid-template-columns:1fr}
  .regions-grid{grid-template-columns:1fr}
  .hero h1{font-size:28px}
  .results-toolbar{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a class="brand" href="#">
      <div class="brand-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><polyline points="3 18 9 6 15 14 18 10 21 14"/></svg>
      </div>
      <span class="brand-name">SpectraLens</span>
    </a>
    <div class="nav-links">
      <button class="nav-btn active" onclick="showPage('analyze',this)">Analyze</button>
      <button class="nav-btn" onclick="showPage('history',this);loadHistory()">History</button>
      <button class="nav-btn" onclick="showPage('library',this);loadLibrary()">Library</button>
    </div>
  </div>
</nav>

<!-- ANALYZE PAGE -->
<div class="page active" id="page-analyze">
  <div class="hero">
    <div class="hero-inner">
      <h1>IR Spectrum<br><em>Comparison Engine</em></h1>
      <p>Upload 2 to 400 infrared spectrum images. AI identifies chemical compounds from curve patterns and overlays all spectra in one comparison chart.</p>
      <div class="hero-stats">
        <div class="stat"><span class="stat-num">400</span><span class="stat-label">Max images</span></div>
        <div class="stat"><span class="stat-num">AI</span><span class="stat-label">Powered</span></div>
        <div class="stat"><span class="stat-num">Chart</span><span class="stat-label">Overlay</span></div>
        <div class="stat"><span class="stat-num">CSV</span><span class="stat-label">Export</span></div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="container">
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Upload Spectrum Images</div>
            <div class="panel-subtitle">JPEG, PNG, WebP ‚Äî 2 to 400 files</div>
          </div>
        </div>
        <div class="panel-body">
          <div class="dropzone" id="dropzone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave()" ondrop="handleDrop(event)">
            <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            <div class="dz-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <div class="dz-title">Drop spectrum images here</div>
            <div class="dz-sub"><span>Browse files</span> or drag and drop</div>
          </div>

          <div id="filePreviewArea" style="display:none">
            <div id="fileCountBadge" class="file-count">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <span id="fileCountText">0 files</span>
            </div>
            <div class="file-grid" id="fileGrid"></div>
          </div>

          <div class="options-row">
            <div class="field">
              <label>Comparison Mode</label>
              <div class="select-wrap">
                <select id="modeSelect" onchange="updateEstimate()">
                  <option value="all_pairs">All vs All ‚Äî every pair compared</option>
                  <option value="sequential">Sequential ‚Äî 1‚Üí2, 2‚Üí3, 3‚Üí4...</option>
                  <option value="vs_first">All vs First ‚Äî compare all to image 1</option>
                </select>
              </div>
            </div>
            <div class="field">
              <label>Sort Results By</label>
              <div class="select-wrap">
                <select id="sortSelect">
                  <option value="similarity_desc">Highest Similarity First</option>
                  <option value="similarity_asc">Lowest Similarity First</option>
                  <option value="order">Analysis Order</option>
                </select>
              </div>
            </div>
          </div>

          <div class="action-row">
            <button class="btn btn-primary" id="analyzeBtn" onclick="startAnalysis()" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Run Analysis
            </button>
            <button class="btn btn-outline" onclick="clearFiles()">Clear</button>
            <div class="pair-estimate" id="pairEstimate"></div>
          </div>

          <div class="error-banner" id="errorBanner"></div>

          <div class="progress-panel" id="progressPanel">
            <div class="progress-header">
              <span class="progress-label" id="progressLabel">Analyzing...</span>
              <span class="progress-pct" id="progressPct">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-sub" id="progressSub"></div>
          </div>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="results-section" id="resultsSection">
        <div class="results-toolbar">
          <h2 class="results-title">Results</h2>
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterResults('all',this)">All</button>
            <button class="filter-tab" onclick="filterResults('same',this)">Same Compound</button>
            <button class="filter-tab" onclick="filterResults('different',this)">Different</button>
            <button class="filter-tab" onclick="filterResults('high',this)">High Match</button>
          </div>
          <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á Export CSV</a>
          <a href="/export-library" class="btn btn-outline btn-sm" style="border-color:var(--teal);color:var(--teal)">‚¨á Export Library</a>
        </div>
        <div class="summary-grid" id="summaryGrid"></div>

        <!-- OVERLAY CHART -->
        <div class="chart-panel" id="chartPanel" style="display:none">
          <div class="chart-title">üìä Spectral Overlay Chart</div>
          <div class="chart-sub">All analyzed spectra plotted together ‚Äî compare curve shapes, troughs, and crests visually</div>
          <div class="chart-container"><canvas id="overlayChart"></canvas></div>
          <div class="chart-legend" id="chartLegend"></div>
        </div>

        <div class="results-list" id="resultsList"></div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRARY PAGE -->
<div class="page" id="page-library">
  <div class="main">
    <div class="container">
      <div class="history-toolbar">
        <h2 class="history-title">Compound Library</h2>
        <div style="display:flex;gap:8px">
          <a href="/export-library" class="btn btn-primary btn-sm">‚¨á Download Library CSV</a>
          <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á Analysis History CSV</a>
        </div>
      </div>
      <p style="font-size:14px;color:var(--ink3);margin-bottom:24px">Every compound identified by AI is saved here automatically. Use this as your personal IR spectra database.</p>
      <div id="libraryContent">
        <div class="empty-state"><div class="empty-icon">üß™</div><div class="empty-title">Library is empty</div><div class="empty-sub">Run analyses to build your compound library</div></div>
      </div>
    </div>
  </div>
</div>

<script>
async function loadLibrary() {
  const content = document.getElementById('libraryContent');
  content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div>`;
  try {
    const res = await fetch('/library');
    const rows = await res.json();
    if (!rows.length) {
      content.innerHTML = `<div class="empty-state"><div class="empty-icon">üß™</div><div class="empty-title">Library is empty</div><div class="empty-sub">Run some analyses first ‚Äî every identified compound is saved here automatically</div></div>`;
      return;
    }

    // Deduplicate by compound name
    const seen = new Set();
    const unique = rows.filter(r => {
      if (seen.has(r.compound_name)) return false;
      seen.add(r.compound_name);
      return true;
    });

    const cards = unique.map(r => {
      const confColor = r.identification_confidence === 'High' ? 'var(--green)' : r.identification_confidence === 'Medium' ? 'var(--amber)' : 'var(--red)';
      const fg = r.functional_groups ? r.functional_groups.split(',').map(g => `<span class="chip" style="color:var(--teal);border-color:rgba(26,107,94,.3)">${g.trim()}</span>`).join('') : '';
      return `<div class="panel" style="margin-bottom:16px">
        <div class="panel-body">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap">
            <div style="flex:1">
              <div style="font-family:var(--serif);font-size:22px;font-weight:600;margin-bottom:4px">${r.compound_name||'Unknown'}</div>
              <div style="font-family:var(--mono);font-size:17px;color:var(--teal);margin-bottom:12px">${r.molecular_formula||'‚Äî'}</div>
              <div class="meta-chips">
                ${r.identification_confidence?`<span class="chip" style="color:${confColor};border-color:${confColor}">Confidence: ${r.identification_confidence}</span>`:''}
                ${r.molecular_weight?`<span class="chip">MW: ${r.molecular_weight}</span>`:''}
                ${r.smiles?`<span class="chip" title="${r.smiles}">SMILES ‚úì</span>`:''}
                ${r.sample_type?`<span class="chip">${r.sample_type}</span>`:''}
              </div>
              ${fg?`<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:6px">Functional Groups</div><div class="meta-chips">${fg}</div></div>`:''}
              ${r.identification_reasoning?`<div style="font-size:13px;color:var(--ink3);line-height:1.6;margin-bottom:8px"><strong style="color:var(--ink2)">AI Reasoning:</strong> ${r.identification_reasoning}</div>`:''}
              ${r.possible_alternatives?`<div style="font-size:13px;color:var(--amber)"><strong>Alternatives:</strong> ${r.possible_alternatives}</div>`:''}
            </div>
            <div style="flex-shrink:0;text-align:right">
              <div style="font-size:11px;color:var(--ink3);font-family:var(--mono)">${r.date_added||''}</div>
              <div style="font-size:12px;color:var(--mid);margin-top:4px">${r.image_filename||''}</div>
            </div>
          </div>
          ${(r.peak_1_wavenumber||r.peak_2_wavenumber||r.peak_3_wavenumber)?`
          <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:10px">Key Peaks</div>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              ${r.peak_1_wavenumber?`<div class="region-card"><div class="region-label">${r.peak_1_wavenumber} cm‚Åª¬π</div><div class="region-text">${r.peak_1_assignment||''}</div></div>`:''}
              ${r.peak_2_wavenumber?`<div class="region-card"><div class="region-label">${r.peak_2_wavenumber} cm‚Åª¬π</div><div class="region-text">${r.peak_2_assignment||''}</div></div>`:''}
              ${r.peak_3_wavenumber?`<div class="region-card"><div class="region-label">${r.peak_3_wavenumber} cm‚Åª¬π</div><div class="region-text">${r.peak_3_assignment||''}</div></div>`:''}
            </div>
          </div>`:''}
        </div>
      </div>`;
    }).join('');

    content.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
        <div style="font-size:14px;color:var(--ink3);font-family:var(--mono)">${unique.length} unique compound${unique.length!==1?'s':''} identified (${rows.length} total entries)</div>
      </div>
      ${cards}`;
  } catch(e) {
    content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Could not load library</div></div>`;
  }
}
</script>


<div class="page" id="page-history">
  <div class="main">
    <div class="container">
      <div class="history-toolbar">
        <h2 class="history-title">Analysis History</h2>
        <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á Export CSV</a>
      </div>
      <div id="historyContent">
        <div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-title">No history yet</div><div class="empty-sub">Run your first analysis to see results here</div></div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE
let allFiles = [];
let allResults = [];
let currentFilter = 'all';
let pollTimer = null;
let overlayChartInstance = null;

// Chart colors for up to 20 spectra
const CHART_COLORS = [
  '#1a6b5e','#c0392b','#b85c1a','#1a6b3a','#2c3e7a',
  '#7d3c98','#2e86c1','#d35400','#1abc9c','#e74c3c',
  '#3498db','#e67e22','#27ae60','#8e44ad','#f39c12',
  '#16a085','#c0392b','#2980b9','#8e44ad','#d35400'
];

// ‚îÄ‚îÄ NAV
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
}

// ‚îÄ‚îÄ FILE HANDLING
function handleFiles(files) {
  const arr = Array.from(files);
  if (arr.length + allFiles.length > 400) { showError('Maximum 400 images.'); return; }
  allFiles = [...allFiles, ...arr];
  renderFilePreviews();
  updateEstimate();
  document.getElementById('analyzeBtn').disabled = allFiles.length < 2;
}

function handleDragOver(e) { e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
function handleDragLeave() { document.getElementById('dropzone').classList.remove('drag-over'); }
function handleDrop(e) { e.preventDefault(); document.getElementById('dropzone').classList.remove('drag-over'); handleFiles(e.dataTransfer.files); }

function renderFilePreviews() {
  const area = document.getElementById('filePreviewArea');
  const grid = document.getElementById('fileGrid');
  if (allFiles.length === 0) { area.style.display = 'none'; return; }
  area.style.display = 'block';
  document.getElementById('fileCountText').textContent = `${allFiles.length} file${allFiles.length > 1 ? 's' : ''} selected`;
  grid.innerHTML = allFiles.slice(0, 60).map((f, i) => {
    const url = URL.createObjectURL(f);
    return `<div class="file-thumb"><img src="${url}" title="${f.name}"><button class="rm-btn" onclick="removeFile(${i})">‚úï</button></div>`;
  }).join('');
  if (allFiles.length > 60) grid.innerHTML += `<div class="file-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--off);font-size:12px;color:var(--ink3);font-family:var(--mono)">+${allFiles.length-60} more</div>`;
}

function removeFile(idx) {
  allFiles.splice(idx, 1);
  renderFilePreviews();
  updateEstimate();
  document.getElementById('analyzeBtn').disabled = allFiles.length < 2;
}

function clearFiles() {
  allFiles = [];
  renderFilePreviews();
  updateEstimate();
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('resultsSection').classList.remove('show');
  document.getElementById('progressPanel').classList.remove('show');
  document.getElementById('chartPanel').style.display = 'none';
  hideError();
}

function updateEstimate() {
  const mode = document.getElementById('modeSelect').value;
  const n = allFiles.length;
  let pairs = mode === 'all_pairs' ? n*(n-1)/2 : Math.max(0, n-1);
  const est = document.getElementById('pairEstimate');
  if (n < 2) { est.textContent = ''; return; }
  const mins = Math.ceil(pairs * 8 / 60);
  est.innerHTML = `<strong>${pairs}</strong> pair${pairs !== 1 ? 's' : ''} ¬∑ ~${mins < 1 ? '<1' : mins} min`;
}

// ‚îÄ‚îÄ ANALYSIS
async function startAnalysis() {
  if (allFiles.length < 2) return;
  hideError();
  const mode = document.getElementById('modeSelect').value;
  const formData = new FormData();
  allFiles.forEach(f => formData.append('images', f));
  formData.append('mode', mode);

  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('progressPanel').classList.add('show');
  document.getElementById('resultsSection').classList.remove('show');
  document.getElementById('chartPanel').style.display = 'none';
  setProgress(0, 0, 'Uploading images...');

  try {
    const res = await fetch('/submit', { method: 'POST', body: formData });
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data.error || 'Upload failed');
    pollJob(data.job_id, data.total_pairs);
  } catch (e) {
    showError(e.message);
    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('progressPanel').classList.remove('show');
  }
}

function pollJob(jobId, total) {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const res = await fetch(`/job/${jobId}`);
      const job = await res.json();
      const pct = total > 0 ? Math.round((job.progress / total) * 100) : 0;
      setProgress(pct, job.progress, `Analyzing pair ${job.progress} of ${total}...`);
      if (job.status === 'complete' || job.status === 'error') {
        clearInterval(pollTimer);
        setProgress(100, total, 'Complete!');
        setTimeout(() => {
          document.getElementById('progressPanel').classList.remove('show');
          document.getElementById('analyzeBtn').disabled = false;
          allResults = job.results || [];
          renderResults();
        }, 600);
      }
    } catch (e) {
      clearInterval(pollTimer);
      showError('Connection lost. Please try again.');
      document.getElementById('analyzeBtn').disabled = false;
    }
  }, 2000);
}

function setProgress(pct, done, label) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressLabel').textContent = label;
  document.getElementById('progressSub').textContent = done > 0 ? `${done} pairs analyzed` : '';
}

// ‚îÄ‚îÄ RENDER RESULTS
function renderResults() {
  const section = document.getElementById('resultsSection');
  section.classList.add('show');
  renderSummary();
  renderOverlayChart();
  renderList(currentFilter);
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderSummary() {
  const done = allResults.filter(r => r.status === 'done');
  const errors = allResults.filter(r => r.status === 'error').length;
  const same = done.filter(r => r.result?.comparison?.is_same_compound).length;
  const avgScore = done.length > 0 ? Math.round(done.reduce((a, r) => a + (r.result?.comparison?.similarity_score || 0), 0) / done.length) : 0;
  document.getElementById('summaryGrid').innerHTML = `
    <div class="summary-card"><div class="sc-num">${done.length}</div><div class="sc-label">Pairs Analyzed</div></div>
    <div class="summary-card"><div class="sc-num" style="color:var(--teal)">${avgScore}%</div><div class="sc-label">Avg Similarity</div></div>
    <div class="summary-card"><div class="sc-num" style="color:var(--green)">${same}</div><div class="sc-label">Same Compound</div></div>
    <div class="summary-card"><div class="sc-num" style="color:${errors>0?'var(--red)':'var(--ink3)'}">${errors}</div><div class="sc-label">Errors</div></div>`;
}

// ‚îÄ‚îÄ OVERLAY CHART
function renderOverlayChart() {
  const done = allResults.filter(r => r.status === 'done');
  if (done.length === 0) return;

  // Collect ALL compounds ‚Äî use image filename as unique key so nothing is skipped
  const compoundMap = {};
  done.forEach(r => {
    const i1 = r.result?.image1;
    const i2 = r.result?.image2;
    // Always use filename as key to avoid deduplication killing second compound
    if (i1 && i1.major_peaks && i1.major_peaks.length > 0) {
      const key = r.image1_name; // unique per image file
      const label = (i1.compound_name && i1.compound_name !== 'Unknown compound') ? i1.compound_name : r.image1_name.replace(/\.[^.]+$/, '');
      compoundMap[key] = { peaks: i1.major_peaks, name: label, formula: i1.chemical_formula || '' };
    }
    if (i2 && i2.major_peaks && i2.major_peaks.length > 0) {
      const key = r.image2_name; // unique per image file
      const label = (i2.compound_name && i2.compound_name !== 'Unknown compound') ? i2.compound_name : r.image2_name.replace(/\.[^.]+$/, '');
      compoundMap[key] = { peaks: i2.major_peaks, name: label, formula: i2.chemical_formula || '' };
    }
  });

  const compounds = Object.values(compoundMap).slice(0, 20);
  if (compounds.length === 0) return;

  document.getElementById('chartPanel').style.display = 'block';

  // Generate smooth curve data for each compound
  // X axis: wavenumber 500 to 4000 (reversed like real IR)
  const xPoints = [];
  for (let w = 4000; w >= 500; w -= 50) xPoints.push(w);

  const datasets = compounds.map((comp, idx) => {
    // Build transmittance curve: start at ~90%, dip at peak positions
    const curveData = xPoints.map(wn => {
      let transmittance = 90; // baseline high transmittance
      comp.peaks.forEach(p => {
        if (p.wavenumber && p.transmittance !== undefined) {
          const dist = Math.abs(wn - p.wavenumber);
          const width = 120; // peak width
          if (dist < width) {
            const dip = (90 - p.transmittance) * Math.exp(-(dist * dist) / (2 * width * width / 4));
            transmittance -= dip;
          }
        }
      });
      return Math.max(0, Math.min(100, transmittance));
    });

    return {
      label: `${comp.name}${comp.formula ? ' (' + comp.formula + ')' : ''}`,
      data: curveData,
      borderColor: CHART_COLORS[idx % CHART_COLORS.length],
      backgroundColor: 'transparent',
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.4
    };
  });

  const ctx = document.getElementById('overlayChart').getContext('2d');
  if (overlayChartInstance) overlayChartInstance.destroy();

  overlayChartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels: xPoints, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => `${ctx[0].label} cm‚Åª¬π`,
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}% T`
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Wavenumber (cm‚Åª¬π)', color: '#6b6760', font: { size: 12 } },
          ticks: {
            maxTicksLimit: 12,
            color: '#6b6760',
            callback: val => xPoints[val] ? xPoints[val] + '' : ''
          },
          grid: { color: '#e8e5df' }
        },
        y: {
          title: { display: true, text: 'Transmittance (%)', color: '#6b6760', font: { size: 12 } },
          min: 0, max: 100,
          ticks: { color: '#6b6760' },
          grid: { color: '#e8e5df' }
        }
      }
    }
  });

  // Render legend
  const legend = document.getElementById('chartLegend');
  legend.innerHTML = compounds.map((comp, idx) => `
    <div class="legend-item">
      <div class="legend-dot" style="background:${CHART_COLORS[idx % CHART_COLORS.length]}"></div>
      <span>${comp.name}${comp.formula ? ' ‚Äî ' + comp.formula : ''}</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ FILTER & LIST
function filterResults(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderList(filter);
}

function renderList(filter) {
  const sortMode = document.getElementById('sortSelect').value;
  let results = [...allResults];
  if (filter === 'same') results = results.filter(r => r.result?.comparison?.is_same_compound);
  else if (filter === 'different') results = results.filter(r => !r.result?.comparison?.is_same_compound);
  else if (filter === 'high') results = results.filter(r => (r.result?.comparison?.similarity_score || 0) >= 70);
  if (sortMode === 'similarity_desc') results.sort((a,b) => (b.result?.comparison?.similarity_score||0)-(a.result?.comparison?.similarity_score||0));
  else if (sortMode === 'similarity_asc') results.sort((a,b) => (a.result?.comparison?.similarity_score||0)-(b.result?.comparison?.similarity_score||0));

  const list = document.getElementById('resultsList');
  if (results.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üî¨</div><div class="empty-title">No results match this filter</div></div>`;
    return;
  }
  list.innerHTML = results.map((r, idx) => buildCard(r, idx)).join('');
}

function buildCard(r, idx) {
  if (r.status === 'error') return `<div class="result-card"><div class="result-card-header" style="cursor:default"><div class="pair-names"><span class="cname">${r.image1_name}</span><span class="vs-divider">vs</span><span class="cname">${r.image2_name}</span></div><span style="font-size:13px;color:var(--red)">Error: ${r.error}</span></div></div>`;

  const c = r.result?.comparison || {};
  const i1 = r.result?.image1 || {};
  const i2 = r.result?.image2 || {};
  const score = c.similarity_score || 0;
  const sc = score >= 70 ? 'score-high' : score >= 40 ? 'score-mid' : 'score-low';
  const uid = `card_${idx}`;

  return `<div class="result-card" id="${uid}">
    <div class="result-card-header" onclick="toggleCard('${uid}')">
      <div class="pair-names">
        <span class="cname">${i1.compound_name || r.image1_name}</span>
        <span class="vs-divider">vs</span>
        <span class="cname">${i2.compound_name || r.image2_name}</span>
      </div>
      <span class="score-pill ${sc}">${score}%</span>
      <span class="badge-same ${c.is_same_compound?'badge-yes':'badge-no'}">${c.is_same_compound?'Same':'Different'}</span>
      <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="result-card-body">${buildDetailTabs(r, uid)}</div>
  </div>`;
}

function buildDetailTabs(r, uid) {
  const i1 = r.result?.image1 || {};
  const i2 = r.result?.image2 || {};
  const c = r.result?.comparison || {};

  return `
  <div class="detail-tabs">
    <button class="dtab active" onclick="switchTab('${uid}','compounds',this)">Compounds</button>
    <button class="dtab" onclick="switchTab('${uid}','chart',this)">Chart</button>
    <button class="dtab" onclick="switchTab('${uid}','peaks',this)">Peaks</button>
    <button class="dtab" onclick="switchTab('${uid}','comparison',this)">Comparison</button>
    <button class="dtab" onclick="switchTab('${uid}','curve',this)">Curve Analysis</button>
  </div>

  <div class="detail-pane active" id="${uid}_compounds">
    <div class="col2">
      ${buildCompoundBlock(i1, 'Spectrum 1')}
      ${buildCompoundBlock(i2, 'Spectrum 2')}
    </div>
  </div>

  <div class="detail-pane" id="${uid}_chart">
    <div style="margin-bottom:12px">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px">üìä Spectral Overlay ‚Äî Both Curves in One Chart</div>
      <div style="font-size:13px;color:var(--ink3)">Both spectra plotted together. Teal = Spectrum 1, Red = Spectrum 2.</div>
    </div>
    <div style="position:relative;height:300px;width:100%">
      <canvas id="${uid}_canvas"></canvas>
    </div>
    <div id="${uid}_legend" style="display:flex;gap:16px;flex-wrap:wrap;margin-top:12px"></div>
    <script>
      (function(){
        setTimeout(function(){
          var i1peaks = ${JSON.stringify(i1.major_peaks || [])};
          var i2peaks = ${JSON.stringify(i2.major_peaks || [])};
          var rawName1 = ${JSON.stringify(i1.compound_name || '')};
          var rawName2 = ${JSON.stringify(i2.compound_name || '')};
          var file1 = ${JSON.stringify(r.image1_name || 'Spectrum 1')};
          var file2 = ${JSON.stringify(r.image2_name || 'Spectrum 2')};
          var formula1 = ${JSON.stringify(i1.chemical_formula || '')};
          var formula2 = ${JSON.stringify(i2.chemical_formula || '')};

          // Use compound name if identified, otherwise use filename
          function cleanName(raw, file) {
            if (!raw || raw === 'Unknown compound' || raw === 'Unknown') return file.replace(/\.[^.]+$/, '');
            return raw;
          }
          var name1 = cleanName(rawName1, file1) + (formula1 ? ' ('+formula1+')' : '');
          var name2 = cleanName(rawName2, file2) + (formula2 ? ' ('+formula2+')' : '');

          var xPts = [];
          for(var w=4000;w>=500;w-=50) xPts.push(w);

          function makeCurve(peaks){
            if(!peaks || peaks.length === 0){
              // Flat line at 85 if no peaks available
              return xPts.map(function(){ return 85; });
            }
            return xPts.map(function(wn){
              var t = 90;
              peaks.forEach(function(p){
                var wnum = parseFloat(p.wavenumber);
                var trans = parseFloat(p.transmittance);
                if(!isNaN(wnum) && !isNaN(trans)){
                  var d = Math.abs(wn - wnum);
                  if(d < 200){
                    var dip = (90 - trans) * Math.exp(-(d*d)/(2*130*130/4));
                    t -= dip;
                  }
                }
              });
              return Math.max(0, Math.min(100, t));
            });
          }

          var ctx = document.getElementById('${uid}_canvas').getContext('2d');
          new Chart(ctx, {
            type:'line',
            data:{
              labels: xPts,
              datasets:[
                {label:name1, data:makeCurve(i1peaks), borderColor:'#1a6b5e', backgroundColor:'rgba(26,107,94,0.07)', borderWidth:2.5, pointRadius:0, tension:0.4, fill:true},
                {label:name2, data:makeCurve(i2peaks), borderColor:'#c0392b', backgroundColor:'rgba(192,57,43,0.07)', borderWidth:2.5, pointRadius:0, tension:0.4, fill:true}
              ]
            },
            options:{
              responsive:true, maintainAspectRatio:false,
              interaction:{mode:'index',intersect:false},
              plugins:{
                legend:{display:false},
                tooltip:{callbacks:{
                  title:function(c){return c[0].label+' cm\u207B\u00B9'},
                  label:function(c){return c.dataset.label+': '+c.parsed.y.toFixed(1)+'% T'}
                }}
              },
              scales:{
                x:{title:{display:true,text:'Wavenumber (cm\u207B\u00B9)',color:'#6b6760',font:{size:11}},ticks:{maxTicksLimit:10,color:'#6b6760',callback:function(v){return xPts[v]?xPts[v]+'':''}},grid:{color:'#e8e5df'}},
                y:{title:{display:true,text:'Transmittance (%)',color:'#6b6760',font:{size:11}},min:0,max:100,ticks:{color:'#6b6760'},grid:{color:'#e8e5df'}}
              }
            }
          });

          document.getElementById('${uid}_legend').innerHTML =
            '<div class="legend-item"><div class="legend-dot" style="background:#1a6b5e"></div><span>'+name1+'</span></div>'+
            '<div class="legend-item"><div class="legend-dot" style="background:#c0392b"></div><span>'+name2+'</span></div>';
        }, 150);
      })();
    <\/script>
  </div>

  <div class="detail-pane" id="${uid}_peaks">
    <div class="col2">
      <div>
        <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:10px">Spectrum 1 ‚Äî ${i1.compound_name||'?'} ${i1.chemical_formula?'('+i1.chemical_formula+')':''}</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Wavenumber</th><th>Trans %</th><th>Assignment</th></tr></thead>
          <tbody>${(i1.major_peaks||[]).map(p=>`<tr><td class="wn">${p.wavenumber} cm‚Åª¬π</td><td class="tr">${p.transmittance}%</td><td class="asgn">${p.assignment}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">No peaks</td></tr>'}</tbody>
        </table></div>
      </div>
      <div>
        <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:10px">Spectrum 2 ‚Äî ${i2.compound_name||'?'} ${i2.chemical_formula?'('+i2.chemical_formula+')':''}</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Wavenumber</th><th>Trans %</th><th>Assignment</th></tr></thead>
          <tbody>${(i2.major_peaks||[]).map(p=>`<tr><td class="wn">${p.wavenumber} cm‚Åª¬π</td><td class="tr">${p.transmittance}%</td><td class="asgn">${p.assignment}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">No peaks</td></tr>'}</tbody>
        </table></div>
      </div>
    </div>
    <div style="margin-top:20px">
      <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--green);margin-bottom:8px">‚úÖ Matching Peaks</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Sp.1 (cm‚Åª¬π)</th><th>Sp.2 (cm‚Åª¬π)</th><th>Œî</th><th>Note</th></tr></thead>
        <tbody>${(c.matching_peaks||[]).map(p=>`<tr class="match-tr"><td class="wn">${p.wavenumber_img1}</td><td class="wn">${p.wavenumber_img2}</td><td class="tr">${p.difference}</td><td class="asgn">${p.note}</td></tr>`).join('')||'<tr><td colspan="4" style="color:var(--mid)">No matching peaks</td></tr>'}</tbody>
      </table></div>
      <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--red);margin:14px 0 8px">‚ùå Non-Matching Peaks</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Wavenumber</th><th>Present In</th><th>Note</th></tr></thead>
        <tbody>${(c.non_matching_peaks||[]).map(p=>`<tr class="nomatch-tr"><td class="wn">${p.wavenumber}</td><td style="color:var(--amber);font-family:var(--mono);font-size:12px">${p.present_in}</td><td class="asgn">${p.note}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">None</td></tr>'}</tbody>
      </table></div>
    </div>
  </div>

  <div class="detail-pane" id="${uid}_comparison">
    <div class="sim-bar-wrap">
      <div class="sim-bar-top"><span style="font-size:13px;color:var(--ink3)">Similarity Score</span><span class="pct">${c.similarity_score||0}%</span></div>
      <div class="sim-bar"><div class="sim-fill" style="width:${c.similarity_score||0}%"></div></div>
    </div>
    <div class="comp-grid">
      <div class="comp-box">
        <div class="box-label">100% Accuracy</div>
        <p style="font-weight:600;color:${c.accuracy_100_percent?'var(--green)':'var(--red)'};margin-bottom:6px">${c.accuracy_100_percent?'‚úì Perfect Match':'‚úó Not Identical'}</p>
        <p>${c.accuracy_explanation||''}</p>
      </div>
      <div class="comp-box">
        <div class="box-label">Functional Groups</div>
        <p>${c.functional_groups_comparison||'‚Äî'}</p>
      </div>
    </div>
    <div class="sim-lists">
      <div><div class="sim-list-title pos">Similarities</div><ul class="sim-list pos">${(c.similarities||[]).map(s=>`<li>${s}</li>`).join('')||'<li>None found</li>'}</ul></div>
      <div><div class="sim-list-title neg">Differences</div><ul class="sim-list neg">${(c.differences||[]).map(d=>`<li>${d}</li>`).join('')||'<li>None found</li>'}</ul></div>
    </div>
    <div class="conclusion-box"><div class="clabel">Conclusion</div>${c.conclusion||'‚Äî'}</div>
  </div>

  <div class="detail-pane" id="${uid}_curve">
    <div style="background:var(--off);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;font-size:13px;color:var(--ink2);line-height:1.7">
      <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px">Trough & Crest Comparison</div>
      ${c.trough_crest_comparison||'‚Äî'}
    </div>
    <div class="comp-grid" style="margin-bottom:16px">
      <div class="comp-box"><div class="box-label">Spectrum 1 Up/Down Pattern</div><p>${c.curve_up_down_analysis?.image1_pattern||'‚Äî'}</p></div>
      <div class="comp-box"><div class="box-label">Spectrum 2 Up/Down Pattern</div><p>${c.curve_up_down_analysis?.image2_pattern||'‚Äî'}</p></div>
    </div>
    <div style="background:var(--teal-l);border:1px solid rgba(26,107,94,.2);border-radius:8px;padding:14px 16px;font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:16px">
      <strong style="color:var(--teal)">How Similar: </strong>${c.curve_up_down_analysis?.how_similar||'‚Äî'}
    </div>
    <div class="col2">
      ${buildRegions(i1,'Spectrum 1 Regions')}
      ${buildRegions(i2,'Spectrum 2 Regions')}
    </div>
  </div>`;
}

function buildCompoundBlock(img, label) {
  const confColor = img.identification_confidence === 'High' ? 'var(--green)' : img.identification_confidence === 'Medium' ? 'var(--amber)' : 'var(--red)';
  return `<div class="info-block">
    <div class="label">${label}</div>
    <div class="compound-big">${img.compound_name||'Unknown Compound'}</div>
    <div class="formula-big">${img.chemical_formula||'‚Äî'}</div>
    <div class="meta-chips">
      ${img.identification_confidence?`<span class="chip" style="color:${confColor};border-color:${confColor}">Confidence: ${img.identification_confidence}</span>`:''}
      ${img.molecular_weight?`<span class="chip">MW: ${img.molecular_weight}</span>`:''}
      ${img.sample_type?`<span class="chip">${img.sample_type}</span>`:''}
    </div>
    ${img.identification_reasoning?`<div style="background:var(--white);border:1px solid var(--border);border-radius:7px;padding:12px;margin-bottom:10px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--teal);margin-bottom:6px">üî¨ How AI Identified This</div><div style="font-size:13px;color:var(--ink2);line-height:1.6">${img.identification_reasoning}</div></div>`:''}
    ${img.possible_alternatives?`<div style="background:var(--amber-l);border:1px solid rgba(184,92,26,.2);border-radius:7px;padding:10px;margin-bottom:10px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--amber);margin-bottom:4px">Possible Alternatives</div><div style="font-size:13px;color:var(--ink2)">${img.possible_alternatives}</div></div>`:''}
    ${img.functional_groups?`<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:6px">Functional Groups</div><div class="meta-chips">${(Array.isArray(img.functional_groups)?img.functional_groups:[img.functional_groups]).map(g=>`<span class="chip" style="color:var(--teal);border-color:rgba(26,107,94,.3)">${g}</span>`).join('')}</div></div>`:''}
    <div class="curve-text">${img.curve_description||''}</div>
  </div>`;
}

function buildRegions(img, title) {
  const r = img.key_regions || {};
  return `<div>
    <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px">${title}</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="region-card"><div class="region-label">4000‚Äì2500 cm‚Åª¬π</div><div class="region-text">${r['4000_2500']||'‚Äî'}</div></div>
      <div class="region-card"><div class="region-label">2500‚Äì1500 cm‚Åª¬π</div><div class="region-text">${r['2500_1500']||'‚Äî'}</div></div>
      <div class="region-card"><div class="region-label">1500‚Äì500 cm‚Åª¬π (Fingerprint)</div><div class="region-text">${r['1500_500']||'‚Äî'}</div></div>
    </div>
  </div>`;
}

function toggleCard(uid) { document.getElementById(uid).classList.toggle('open'); }

function switchTab(uid, tab, btn) {
  const card = document.getElementById(uid);
  card.querySelectorAll('.dtab').forEach(t => t.classList.remove('active'));
  card.querySelectorAll('.detail-pane').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`${uid}_${tab}`).classList.add('active');
}

// ‚îÄ‚îÄ HISTORY
async function loadHistory() {
  const content = document.getElementById('historyContent');
  content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div>`;
  try {
    const res = await fetch('/history');
    const rows = await res.json();
    if (!rows.length) { content.innerHTML = `<div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-title">No history yet</div><div class="empty-sub">Run your first analysis</div></div>`; return; }
    const tbody = [...rows].reverse().map(r => {
      const s = parseInt(r.similarity_score||0);
      const sc = s>=70?'score-h':s>=40?'score-m':'score-l';
      return `<tr><td style="color:var(--ink3);font-family:var(--mono);font-size:12px">${r.timestamp}</td><td><strong>${r.compound1}</strong><br><span style="font-family:var(--mono);font-size:12px;color:var(--teal)">${r.formula1}</span></td><td><strong>${r.compound2}</strong><br><span style="font-family:var(--mono);font-size:12px;color:var(--teal)">${r.formula2}</span></td><td><span class="score-cell ${sc}">${s}%</span></td><td><span class="badge-same ${r.is_same_compound==='True'?'badge-yes':'badge-no'}">${r.is_same_compound==='True'?'Same':'Different'}</span></td></tr>`;
    }).join('');
    content.innerHTML = `<div class="history-table-wrap"><table class="htable"><thead><tr><th>Time</th><th>Compound 1</th><th>Compound 2</th><th>Score</th><th>Same?</th></tr></thead><tbody>${tbody}</tbody></table></div><p style="font-size:12px;color:var(--ink3);margin-top:10px;font-family:var(--mono)">${rows.length} total records</p>`;
  } catch(e) { content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Could not load history</div></div>`; }
}

// ‚îÄ‚îÄ UTILS
function showError(msg) { const b=document.getElementById('errorBanner'); b.textContent=msg; b.style.display='block'; }
function hideError() { document.getElementById('errorBanner').style.display='none'; }
</script>
</body>
</html>
