<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="google-site-verification" content="P8Zytb0rGqAcWqGS7YabJ79YlMCjktxgWtC74mAG1uI" />
<title>SpectraLens ‚Äî Free IR Spectrum Analyzer & Comparison Tool</title>
<meta name="description" content="SpectraLens is a free AI-powered IR spectrum analysis tool. Upload 2 to 400 infrared spectrum images to identify chemical compounds, compare peak patterns, and get similarity scores instantly.">
<meta name="keywords" content="IR spectrum analyzer, infrared spectroscopy tool, spectrum comparison, chemical compound identification, IR spectra similarity, FTIR analysis, peak comparison, free spectrum tool, chemistry analyzer">
<meta name="author" content="SpectraLens">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#1a6b5e">
<link rel="canonical" href="https://spectralens-production.up.railway.app/">
<meta property="og:title" content="SpectraLens ‚Äî Free IR Spectrum Analyzer">
<meta property="og:description" content="Upload 2 to 400 IR spectrum images. AI identifies compounds from curve shape, compares peaks, scores similarity. Free to use.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://spectralens-production.up.railway.app/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpectraLens ‚Äî Free IR Spectrum Analyzer">
<meta name="twitter:description" content="AI-powered IR spectrum comparison. Upload 2‚Äì400 images, identify compounds from curves, compare peaks.">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"SpectraLens","description":"Free AI-powered IR spectrum analysis and comparison tool for chemistry. Identifies chemical compounds from curve shape. Supports bulk comparison of up to 400 infrared spectrum images.","url":"https://spectralens-production.up.railway.app/","applicationCategory":"Science","operatingSystem":"Web Browser","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"featureList":["IR spectrum curve analysis","Chemical compound identification from curve shape","Bulk image comparison up to 400 images","Peak pattern comparison","Similarity scoring","Compound library download","CSV export"]}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --white:#ffffff;--off:#f7f6f3;--stone:#e8e5df;--mid:#c4bfb5;
  --ink:#1a1916;--ink2:#3d3a34;--ink3:#6b6760;
  --teal:#1a6b5e;--teal-light:#e8f4f1;--teal-mid:#2a9d8f;
  --amber:#b85c1a;--amber-light:#fdf0e8;
  --red:#c0392b;--red-light:#fdf0ef;
  --green:#1a6b3a;--green-light:#e8f4ec;
  --border:#e0ddd6;
  --shadow:0 1px 3px rgba(26,25,22,.08),0 4px 16px rgba(26,25,22,.04);
  --shadow-lg:0 4px 6px rgba(26,25,22,.06),0 12px 40px rgba(26,25,22,.1);
  --r:10px;
  --mono:'DM Mono',monospace;
  --sans:'DM Sans',sans-serif;
  --serif:'Fraunces',serif;
}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:var(--sans);background:var(--off);color:var(--ink);font-size:15px;line-height:1.6;min-height:100vh}

/* NAV */
nav{background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;height:56px;display:flex;align-items:center}
.nav-inner{max-width:1200px;margin:0 auto;width:100%;padding:0 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;flex-shrink:0}
.brand-mark{width:30px;height:30px;background:var(--ink);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.brand-mark svg{width:16px;height:16px}
.brand-name{font-family:var(--serif);font-size:17px;font-weight:600;letter-spacing:-.3px;color:var(--ink)}
.nav-links{display:flex;gap:2px;flex-shrink:0}
.nav-btn{background:none;border:none;padding:6px 12px;border-radius:7px;font-family:var(--sans);font-size:13px;font-weight:500;color:var(--ink3);cursor:pointer;transition:all .15s;white-space:nowrap}
.nav-btn:hover{background:var(--off);color:var(--ink)}
.nav-btn.active{background:var(--ink);color:var(--white)}

/* PAGES */
.page{display:none}
.page.active{display:block}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* HERO */
.hero{padding:40px 0 32px;border-bottom:1px solid var(--border);background:var(--white)}
.hero-inner{max-width:1200px;margin:0 auto;padding:0 20px}
.hero h1{font-family:var(--serif);font-size:clamp(26px,5vw,40px);font-weight:300;line-height:1.15;letter-spacing:-1px;color:var(--ink);max-width:600px;margin-bottom:10px}
.hero h1 em{font-style:italic;color:var(--teal)}
.hero p{color:var(--ink3);font-size:15px;max-width:480px;margin-bottom:24px}
.hero-stats{display:flex;gap:24px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column}
.stat-num{font-family:var(--mono);font-size:20px;font-weight:500;color:var(--ink);line-height:1}
.stat-label{font-size:11px;color:var(--ink3);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}

/* MAIN */
.main{padding:32px 0 80px}

/* PANEL */
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.panel-title{font-size:14px;font-weight:600;color:var(--ink);letter-spacing:-.2px}
.panel-subtitle{font-size:12px;color:var(--ink3);margin-top:1px}
.panel-body{padding:20px}

/* DROP ZONE */
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:36px 20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--off)}
.dropzone:hover,.dropzone.drag-over{border-color:var(--teal);background:var(--teal-light)}
.dropzone input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{width:44px;height:44px;background:var(--white);border:1px solid var(--border);border-radius:11px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;box-shadow:var(--shadow)}
.dz-icon svg{width:20px;height:20px;color:var(--teal)}
.dz-title{font-size:14px;font-weight:500;color:var(--ink);margin-bottom:4px}
.dz-sub{font-size:13px;color:var(--ink3)}
.dz-sub span{color:var(--teal);font-weight:500;text-decoration:underline;text-underline-offset:2px}

/* FILE GRID */
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px;margin-top:14px;max-height:280px;overflow-y:auto}
.file-thumb{position:relative;border-radius:6px;overflow:hidden;border:1px solid var(--border);background:var(--white);aspect-ratio:1}
.file-thumb img{width:100%;height:100%;object-fit:cover}
.file-thumb .rm{position:absolute;top:3px;right:3px;width:18px;height:18px;background:rgba(26,25,22,.7);border:none;border-radius:50%;color:white;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center}
.file-thumb:hover .rm{display:flex}
.file-count-badge{display:inline-flex;align-items:center;gap:6px;background:var(--teal-light);color:var(--teal);border:1px solid rgba(26,107,94,.2);padding:5px 12px;border-radius:20px;font-size:13px;font-weight:500;margin-top:10px}

/* OPTIONS */
.options-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px}
.field label{display:block;font-size:11px;font-weight:500;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.field select{width:100%;padding:9px 32px 9px 12px;border:1px solid var(--border);border-radius:7px;font-family:var(--sans);font-size:14px;color:var(--ink);background:var(--white);appearance:none;outline:none;transition:border .15s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236b6760' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.field select:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(26,107,94,.1)}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 20px;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;border:none;text-decoration:none;white-space:nowrap}
.btn-primary{background:var(--ink);color:var(--white)}
.btn-primary:hover{background:var(--ink2);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
.btn-primary:disabled{opacity:.45;pointer-events:none;transform:none}
.btn-outline{background:var(--white);color:var(--ink);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--ink3);background:var(--off)}
.btn-teal{background:var(--teal);color:var(--white)}
.btn-teal:hover{background:var(--teal-mid);transform:translateY(-1px)}
.btn-sm{padding:7px 14px;font-size:13px}
.action-row{display:flex;align-items:center;gap:10px;margin-top:20px;padding-top:18px;border-top:1px solid var(--border);flex-wrap:wrap}
.pair-estimate{margin-left:auto;font-size:13px;color:var(--ink3);font-family:var(--mono)}
.pair-estimate strong{color:var(--teal)}

/* PROGRESS */
.progress-panel{margin-top:20px;display:none}
.progress-panel.show{display:block}
.progress-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.progress-label{font-size:14px;font-weight:500}
.progress-pct{font-family:var(--mono);font-size:14px;color:var(--teal)}
.progress-track{height:6px;background:var(--stone);border-radius:3px;overflow:hidden;margin-bottom:6px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:3px;transition:width .4s ease;width:0%}
.progress-sub{font-size:12px;color:var(--ink3)}

/* RESULTS */
.results-section{margin-top:28px;display:none}
.results-section.show{display:block}
.results-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.results-title{font-family:var(--serif);font-size:clamp(20px,4vw,26px);font-weight:300;letter-spacing:-.5px;margin-right:auto}
.filter-tabs{display:flex;gap:3px;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:3px}
.filter-tab{padding:5px 10px;border-radius:5px;font-size:12px;font-weight:500;border:none;background:none;cursor:pointer;color:var(--ink3);transition:all .15s}
.filter-tab.active{background:var(--ink);color:var(--white)}

/* SUMMARY */
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.summary-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px 18px}
.sc-num{font-family:var(--mono);font-size:26px;font-weight:500;line-height:1;margin-bottom:3px}
.sc-label{font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px}

/* RESULT CARDS */
.results-list{display:flex;flex-direction:column;gap:10px}
.result-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .2s}
.result-card:hover{box-shadow:var(--shadow-lg)}
.result-card-header{padding:14px 18px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;flex-wrap:wrap}
.pair-names{flex:1;display:flex;align-items:center;gap:7px;font-size:13px;font-weight:500;min-width:0;flex-wrap:wrap}
.cname{font-family:var(--mono);font-size:12px;color:var(--ink);background:var(--off);padding:3px 8px;border-radius:5px;border:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.vs-divider{font-size:10px;color:var(--mid);font-weight:500;text-transform:uppercase;letter-spacing:1px;flex-shrink:0}
.score-pill{font-family:var(--mono);font-size:13px;font-weight:500;padding:3px 10px;border-radius:20px;flex-shrink:0}
.score-high{background:var(--green-light);color:var(--green)}
.score-mid{background:var(--amber-light);color:var(--amber)}
.score-low{background:var(--red-light);color:var(--red)}
.badge-same{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:4px;flex-shrink:0}
.badge-yes{background:var(--green-light);color:var(--green)}
.badge-no{background:var(--red-light);color:var(--red)}
.chevron{width:18px;height:18px;color:var(--mid);transition:transform .2s;flex-shrink:0}
.result-card.open .chevron{transform:rotate(180deg)}
.result-card-body{display:none;border-top:1px solid var(--border)}
.result-card.open .result-card-body{display:block}

/* DETAIL TABS */
.detail-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);padding:0 18px;background:var(--off);overflow-x:auto;-webkit-overflow-scrolling:touch}
.dtab{padding:10px 14px;font-size:12px;font-weight:500;color:var(--ink3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap;flex-shrink:0}
.dtab:hover{color:var(--ink)}
.dtab.active{color:var(--teal);border-bottom-color:var(--teal)}
.detail-pane{display:none;padding:18px}
.detail-pane.active{display:block}

/* COMPOUND COLS */
.col2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.info-block{background:var(--off);border:1px solid var(--border);border-radius:8px;padding:14px}
.info-block .label{font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:10px}
.compound-big{font-family:var(--serif);font-size:18px;font-weight:600;line-height:1.2;margin-bottom:3px}
.formula-big{font-family:var(--mono);font-size:15px;color:var(--teal);margin-bottom:10px}
.meta-chips{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.chip{font-size:11px;font-family:var(--mono);padding:3px 7px;border-radius:4px;background:var(--white);border:1px solid var(--border);color:var(--ink3)}
.curve-text{font-size:13px;color:var(--ink3);line-height:1.6}

/* REASONING BOX */
.reasoning-box{background:var(--white);border:1px solid var(--border);border-radius:7px;padding:12px;margin-bottom:10px}
.reasoning-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--teal);margin-bottom:6px}
.reasoning-text{font-size:13px;color:var(--ink2);line-height:1.6}
.alt-box{background:var(--amber-light);border:1px solid rgba(184,92,26,.2);border-radius:7px;padding:10px;margin-bottom:10px}
.alt-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--amber);margin-bottom:4px}
.alt-text{font-size:13px;color:var(--ink2)}

/* TABLES */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{border-bottom:1px solid var(--border)}
th{text-align:left;padding:8px 10px;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);white-space:nowrap}
td{padding:8px 10px;border-bottom:1px solid var(--stone)}
tr:last-child td{border-bottom:none}
.wn{font-family:var(--mono);font-weight:500;color:var(--teal)}
.tr{font-family:var(--mono);color:var(--amber)}
.asgn{color:var(--ink3)}
tr.match-tr{background:rgba(26,107,58,.03)}
tr.nomatch-tr{background:rgba(192,57,43,.03)}

/* COMPARISON */
.comp-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.comp-box{background:var(--off);border:1px solid var(--border);border-radius:8px;padding:12px 14px}
.comp-box .box-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:7px}
.comp-box p{font-size:13px;color:var(--ink2);line-height:1.6}
.sim-bar-wrap{margin-bottom:18px}
.sim-bar-top{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px}
.sim-bar-top .pct{font-family:var(--mono);font-weight:500;color:var(--teal)}
.sim-bar{height:8px;background:var(--stone);border-radius:4px;overflow:hidden}
.sim-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--teal),var(--teal-mid))}
.sim-lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.sim-list-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px}
.sim-list-title.pos{color:var(--green)}
.sim-list-title.neg{color:var(--red)}
.sim-list{list-style:none}
.sim-list li{font-size:13px;padding:6px 10px;border-radius:6px;margin-bottom:4px;line-height:1.5}
.sim-list.pos li{background:var(--green-light);color:var(--ink2)}
.sim-list.neg li{background:var(--red-light);color:var(--ink2)}
.conclusion-box{background:var(--off);border-left:3px solid var(--teal);padding:12px 14px;border-radius:0 6px 6px 0;font-size:13px;color:var(--ink2);line-height:1.7}
.conclusion-box .clabel{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--teal);margin-bottom:5px}

/* REGIONS */
.regions-wrap{margin-top:14px}
.region-card{background:var(--white);border:1px solid var(--border);border-radius:7px;padding:10px;margin-bottom:8px}
.region-label{font-family:var(--mono);font-size:11px;color:var(--teal);margin-bottom:4px;font-weight:500}
.region-text{font-size:12px;color:var(--ink3);line-height:1.5}

/* LIBRARY PAGE */
.lib-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.lib-title{font-family:var(--serif);font-size:clamp(22px,4vw,28px);font-weight:300;letter-spacing:-.5px}
.lib-stats{display:flex;gap:16px;flex-wrap:wrap}
.lib-stat{font-size:13px;color:var(--ink3);font-family:var(--mono)}
.lib-stat strong{color:var(--teal)}
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.lib-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow);transition:box-shadow .2s}
.lib-card:hover{box-shadow:var(--shadow-lg)}
.lib-compound{font-family:var(--serif);font-size:17px;font-weight:600;margin-bottom:3px;line-height:1.2}
.lib-formula{font-family:var(--mono);font-size:15px;color:var(--teal);margin-bottom:10px}
.lib-row{display:flex;justify-content:space-between;font-size:12px;color:var(--ink3);padding:4px 0;border-bottom:1px solid var(--stone)}
.lib-row:last-child{border-bottom:none}
.lib-row strong{color:var(--ink2);font-weight:500}
.lib-chips{display:flex;gap:4px;flex-wrap:wrap;margin:10px 0}
.lib-chip{font-size:11px;padding:2px 7px;border-radius:3px;background:var(--teal-light);color:var(--teal);font-weight:500}
.conf-high{color:var(--green);font-weight:600}
.conf-med{color:var(--amber);font-weight:600}
.conf-low{color:var(--red);font-weight:600}

/* HISTORY */
.history-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.history-title{font-family:var(--serif);font-size:clamp(22px,4vw,28px);font-weight:300;letter-spacing:-.5px}
.htable-wrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;overflow-x:auto;-webkit-overflow-scrolling:touch}
.htable{width:100%;border-collapse:collapse;min-width:600px;font-size:13px}
.htable th{background:var(--off);padding:10px 12px;text-align:left;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);border-bottom:1px solid var(--border);white-space:nowrap}
.htable td{padding:10px 12px;border-bottom:1px solid var(--stone)}
.htable tr:last-child td{border-bottom:none}
.htable tr:hover td{background:var(--off)}
.score-cell{font-family:var(--mono);font-weight:500}
.score-h{color:var(--green)}.score-m{color:var(--amber)}.score-l{color:var(--red)}

/* EMPTY */
.empty-state{text-align:center;padding:60px 20px}
.empty-icon{font-size:36px;margin-bottom:12px}
.empty-title{font-family:var(--serif);font-size:18px;font-weight:300;margin-bottom:5px}
.empty-sub{font-size:13px;color:var(--ink3)}

/* ERROR */
.error-banner{background:var(--red-light);border:1px solid rgba(192,57,43,.25);border-radius:8px;padding:12px 14px;font-size:13px;color:var(--red);margin-top:14px;display:none}

/* MOBILE */
@media(max-width:640px){
  .col2,.comp-grid,.sim-lists,.options-row{grid-template-columns:1fr}
  .summary-grid{grid-template-columns:repeat(2,1fr)}
  .results-toolbar{flex-direction:column;align-items:flex-start}
  .action-row{flex-direction:column;align-items:stretch}
  .action-row .btn{justify-content:center}
  .pair-estimate{margin-left:0}
  .lib-toolbar,.history-toolbar{flex-direction:column;align-items:flex-start}
  .filter-tabs{overflow-x:auto;width:100%}
}
@media(max-width:400px){
  .brand-name{display:none}
  .cname{max-width:120px}
}
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a class="brand" href="#">
      <div class="brand-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><polyline points="3 18 9 6 15 14 18 10 21 14"/></svg>
      </div>
      <span class="brand-name">SpectraLens</span>
    </a>
    <div class="nav-links">
      <button class="nav-btn active" onclick="showPage('analyze',this)">Analyze</button>
      <button class="nav-btn" onclick="showPage('library',this);loadLibrary()">Library</button>
      <button class="nav-btn" onclick="showPage('history',this);loadHistory()">History</button>
    </div>
  </div>
</nav>

<!-- ANALYZE PAGE -->
<div class="page active" id="page-analyze">
  <div class="hero">
    <div class="hero-inner">
      <h1>IR Spectrum<br><em>Comparison Engine</em></h1>
      <p>Upload 2 to 400 infrared spectrum images. AI identifies compounds from curve shape, compares peaks, and scores similarity.</p>
      <div class="hero-stats">
        <div class="stat"><span class="stat-num">400</span><span class="stat-label">Max images</span></div>
        <div class="stat"><span class="stat-num">AI</span><span class="stat-label">Curve Analysis</span></div>
        <div class="stat"><span class="stat-num">CSV</span><span class="stat-label">Export</span></div>
        <div class="stat"><span class="stat-num">LIB</span><span class="stat-label">Library</span></div>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="panel">
        <div class="panel-header">
          <div><div class="panel-title">Upload Spectrum Images</div><div class="panel-subtitle">JPEG, PNG, WebP ‚Äî 2 to 400 files</div></div>
        </div>
        <div class="panel-body">
          <div class="dropzone" id="dropzone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave()" ondrop="handleDrop(event)">
            <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            <div class="dz-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
            <div class="dz-title">Drop spectrum images here</div>
            <div class="dz-sub"><span>Browse files</span> or drag and drop ¬∑ 2‚Äì400 images</div>
          </div>
          <div id="filePreviewArea" style="display:none">
            <div id="fileCountBadge" class="file-count-badge">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <span id="fileCountText">0 files</span>
            </div>
            <div class="file-grid" id="fileGrid"></div>
          </div>
          <div class="options-row">
            <div class="field">
              <label>Comparison Mode</label>
              <select id="modeSelect" onchange="updateEstimate()">
                <option value="all_pairs">All vs All ‚Äî every pair</option>
                <option value="sequential">Sequential ‚Äî 1‚Üí2, 2‚Üí3...</option>
                <option value="vs_first">All vs First image</option>
              </select>
            </div>
            <div class="field">
              <label>Sort Results By</label>
              <select id="sortSelect">
                <option value="similarity_desc">Highest Similarity First</option>
                <option value="similarity_asc">Lowest Similarity First</option>
                <option value="order">Analysis Order</option>
              </select>
            </div>
          </div>
          <div class="action-row">
            <button class="btn btn-primary" id="analyzeBtn" onclick="startAnalysis()" disabled>
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Run Analysis
            </button>
            <button class="btn btn-outline" onclick="clearFiles()">Clear</button>
            <div class="pair-estimate" id="pairEstimate"></div>
          </div>
          <div class="error-banner" id="errorBanner"></div>
          <div class="progress-panel" id="progressPanel">
            <div class="progress-header">
              <span class="progress-label" id="progressLabel">Analyzing...</span>
              <span class="progress-pct" id="progressPct">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-sub" id="progressSub"></div>
          </div>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="results-section" id="resultsSection">
        <div class="results-toolbar">
          <h2 class="results-title">Results</h2>
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterResults('all',this)">All</button>
            <button class="filter-tab" onclick="filterResults('same',this)">Same</button>
            <button class="filter-tab" onclick="filterResults('different',this)">Different</button>
            <button class="filter-tab" onclick="filterResults('high',this)">High Match</button>
          </div>
          <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á CSV</a>
          <a href="/export-library" class="btn btn-teal btn-sm">‚¨á Library</a>
        </div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="results-list" id="resultsList"></div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRARY PAGE -->
<div class="page" id="page-library">
  <div class="main">
    <div class="container">
      <div class="lib-toolbar">
        <div>
          <h2 class="lib-title">Compound Library</h2>
          <p style="font-size:13px;color:var(--ink3);margin-top:4px">Organised database of all compounds identified from your spectrum images</p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a href="/export-library" class="btn btn-teal btn-sm">‚¨á Download Library CSV</a>
          <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á Analysis History</a>
        </div>
      </div>
      <div class="lib-stats" id="libStats" style="margin-bottom:20px"></div>
      <div id="libraryContent">
        <div class="empty-state"><div class="empty-icon">üß™</div><div class="empty-title">Library is empty</div><div class="empty-sub">Run some analyses first ‚Äî every compound analyzed gets saved here automatically</div></div>
      </div>
    </div>
  </div>
</div>

<!-- HISTORY PAGE -->
<div class="page" id="page-history">
  <div class="main">
    <div class="container">
      <div class="history-toolbar">
        <h2 class="history-title">Analysis History</h2>
        <a href="/export-csv" class="btn btn-outline btn-sm">‚¨á Export CSV</a>
      </div>
      <div id="historyContent">
        <div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-title">No history yet</div><div class="empty-sub">Run your first analysis to see results here</div></div>
      </div>
    </div>
  </div>
</div>

<script>
let allFiles=[], allResults=[], currentFilter='all', pollTimer=null;

function showPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
}

function handleFiles(files){
  const arr=Array.from(files);
  if(arr.length+allFiles.length>400){showError('Maximum 400 images.');return;}
  allFiles=[...allFiles,...arr];
  renderFilePreviews();updateEstimate();
  document.getElementById('analyzeBtn').disabled=allFiles.length<2;
}
function handleDragOver(e){e.preventDefault();document.getElementById('dropzone').classList.add('drag-over')}
function handleDragLeave(){document.getElementById('dropzone').classList.remove('drag-over')}
function handleDrop(e){e.preventDefault();document.getElementById('dropzone').classList.remove('drag-over');handleFiles(e.dataTransfer.files)}

function renderFilePreviews(){
  const area=document.getElementById('filePreviewArea');
  const grid=document.getElementById('fileGrid');
  if(!allFiles.length){area.style.display='none';return;}
  area.style.display='block';
  document.getElementById('fileCountText').textContent=`${allFiles.length} file${allFiles.length>1?'s':''} selected`;
  grid.innerHTML=allFiles.slice(0,60).map((f,i)=>{
    const url=URL.createObjectURL(f);
    return `<div class="file-thumb"><img src="${url}" alt="${f.name}" title="${f.name}" loading="lazy"><button class="rm" onclick="removeFile(${i})" aria-label="Remove">‚úï</button></div>`;
  }).join('');
  if(allFiles.length>60) grid.innerHTML+=`<div class="file-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--off);font-size:12px;color:var(--ink3);font-family:var(--mono)">+${allFiles.length-60}</div>`;
}
function removeFile(idx){allFiles.splice(idx,1);renderFilePreviews();updateEstimate();document.getElementById('analyzeBtn').disabled=allFiles.length<2;}
function clearFiles(){allFiles=[];renderFilePreviews();updateEstimate();document.getElementById('analyzeBtn').disabled=true;document.getElementById('resultsSection').classList.remove('show');document.getElementById('progressPanel').classList.remove('show');hideError();}

function updateEstimate(){
  const mode=document.getElementById('modeSelect').value;
  const n=allFiles.length;
  let pairs=0;
  if(mode==='all_pairs') pairs=n*(n-1)/2;
  else if(mode==='sequential') pairs=Math.max(0,n-1);
  else if(mode==='vs_first') pairs=Math.max(0,n-1);
  const est=document.getElementById('pairEstimate');
  if(n<2){est.textContent='';return;}
  const mins=Math.ceil(pairs*8/60);
  est.innerHTML=`<strong>${pairs}</strong> pair${pairs!==1?'s':''} ¬∑ ~${mins<1?'<1':mins} min`;
}

async function startAnalysis(){
  if(allFiles.length<2)return;
  hideError();
  const mode=document.getElementById('modeSelect').value;
  const formData=new FormData();
  allFiles.forEach(f=>formData.append('images',f));
  formData.append('mode',mode);
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('progressPanel').classList.add('show');
  document.getElementById('resultsSection').classList.remove('show');
  setProgress(0,0,'Uploading images...');
  try{
    const res=await fetch('/submit',{method:'POST',body:formData});
    const data=await res.json();
    if(!res.ok||data.error)throw new Error(data.error||'Upload failed');
    pollJob(data.job_id,data.total_pairs);
  }catch(e){
    showError(e.message);
    document.getElementById('analyzeBtn').disabled=false;
    document.getElementById('progressPanel').classList.remove('show');
  }
}

function pollJob(jobId,total){
  if(pollTimer)clearInterval(pollTimer);
  pollTimer=setInterval(async()=>{
    try{
      const res=await fetch(`/job/${jobId}`);
      const job=await res.json();
      const pct=total>0?Math.round((job.progress/total)*100):0;
      setProgress(pct,job.progress,`Analyzing pair ${job.progress} of ${total}...`);
      if(job.status==='complete'||job.status==='error'){
        clearInterval(pollTimer);
        setProgress(100,total,'Complete!');
        setTimeout(()=>{
          document.getElementById('progressPanel').classList.remove('show');
          document.getElementById('analyzeBtn').disabled=false;
          allResults=job.results||[];
          renderResults();
        },600);
      }
    }catch(e){clearInterval(pollTimer);showError('Connection lost. Please try again.');document.getElementById('analyzeBtn').disabled=false;}
  },2000);
}

function setProgress(pct,done,label){
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressPct').textContent=pct+'%';
  document.getElementById('progressLabel').textContent=label;
  document.getElementById('progressSub').textContent=done>0?`${done} pairs analyzed`:'';
}

function renderResults(){
  document.getElementById('resultsSection').classList.add('show');
  renderSummary();renderList(currentFilter);
  document.getElementById('resultsSection').scrollIntoView({behavior:'smooth',block:'start'});
}

function renderSummary(){
  const done=allResults.filter(r=>r.status==='done');
  const errors=allResults.filter(r=>r.status==='error').length;
  const same=done.filter(r=>r.result?.comparison?.is_same_compound).length;
  const avg=done.length>0?Math.round(done.reduce((a,r)=>a+(r.result?.comparison?.similarity_score||0),0)/done.length):0;
  document.getElementById('summaryGrid').innerHTML=`
    <div class="summary-card"><div class="sc-num">${done.length}</div><div class="sc-label">Analyzed</div></div>
    <div class="summary-card"><div class="sc-num" style="color:var(--teal)">${avg}%</div><div class="sc-label">Avg Similarity</div></div>
    <div class="summary-card"><div class="sc-num" style="color:var(--green)">${same}</div><div class="sc-label">Same Compound</div></div>
    <div class="summary-card"><div class="sc-num" style="color:${errors>0?'var(--red)':'var(--ink3)'}">${errors}</div><div class="sc-label">Errors</div></div>`;
}

function filterResults(filter,btn){
  currentFilter=filter;
  document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderList(filter);
}

function renderList(filter){
  const sortMode=document.getElementById('sortSelect').value;
  let results=[...allResults];
  if(filter==='same') results=results.filter(r=>r.result?.comparison?.is_same_compound);
  else if(filter==='different') results=results.filter(r=>!r.result?.comparison?.is_same_compound);
  else if(filter==='high') results=results.filter(r=>(r.result?.comparison?.similarity_score||0)>=70);
  if(sortMode==='similarity_desc') results.sort((a,b)=>(b.result?.comparison?.similarity_score||0)-(a.result?.comparison?.similarity_score||0));
  else if(sortMode==='similarity_asc') results.sort((a,b)=>(a.result?.comparison?.similarity_score||0)-(b.result?.comparison?.similarity_score||0));
  const list=document.getElementById('resultsList');
  if(!results.length){list.innerHTML=`<div class="empty-state"><div class="empty-icon">üî¨</div><div class="empty-title">No results match</div></div>`;return;}
  list.innerHTML=results.map((r,idx)=>buildCard(r,idx)).join('');
}

function buildCard(r,idx){
  if(r.status==='error') return `<div class="result-card"><div class="result-card-header" style="cursor:default"><div class="pair-names"><span class="cname">${r.image1_name}</span><span class="vs-divider">vs</span><span class="cname">${r.image2_name}</span></div><span style="font-size:12px;color:var(--red)">Error: ${r.error}</span></div></div>`;
  const c=r.result?.comparison||{};
  const i1=r.result?.image1||{};
  const i2=r.result?.image2||{};
  const score=c.similarity_score||0;
  const sc=score>=70?'score-high':score>=40?'score-mid':'score-low';
  const uid=`card_${idx}`;
  return `<div class="result-card" id="${uid}">
    <div class="result-card-header" onclick="toggleCard('${uid}')">
      <div class="pair-names">
        <span class="cname" title="${i1.compound_name||r.image1_name}">${i1.compound_name||r.image1_name}</span>
        <span class="vs-divider">vs</span>
        <span class="cname" title="${i2.compound_name||r.image2_name}">${i2.compound_name||r.image2_name}</span>
      </div>
      <span class="score-pill ${sc}">${score}%</span>
      <span class="badge-same ${c.is_same_compound?'badge-yes':'badge-no'}">${c.is_same_compound?'Same':'Diff'}</span>
      <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
    <div class="result-card-body">${buildDetailTabs(r,uid)}</div>
  </div>`;
}

function buildDetailTabs(r,uid){
  const i1=r.result?.image1||{};
  const i2=r.result?.image2||{};
  const c=r.result?.comparison||{};
  return `
  <div class="detail-tabs">
    <button class="dtab active" onclick="switchTab('${uid}','compounds',this)">Compounds</button>
    <button class="dtab" onclick="switchTab('${uid}','peaks',this)">Peaks</button>
    <button class="dtab" onclick="switchTab('${uid}','comparison',this)">Comparison</button>
    <button class="dtab" onclick="switchTab('${uid}','curve',this)">Curve</button>
  </div>
  <div class="detail-pane active" id="${uid}_compounds">
    <div class="col2">${buildCompBlock(i1,'Spectrum 1')}${buildCompBlock(i2,'Spectrum 2')}</div>
  </div>
  <div class="detail-pane" id="${uid}_peaks">
    <div class="col2">
      <div><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px">${i1.compound_name||'Spectrum 1'}</div>
      <div class="table-wrap"><table><thead><tr><th>Wavenumber</th><th>Trans%</th><th>Assignment</th></tr></thead><tbody>${(i1.major_peaks||[]).map(p=>`<tr><td class="wn">${p.wavenumber} cm‚Åª¬π</td><td class="tr">${p.transmittance}%</td><td class="asgn">${p.assignment}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">No peaks</td></tr>'}</tbody></table></div></div>
      <div><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px">${i2.compound_name||'Spectrum 2'}</div>
      <div class="table-wrap"><table><thead><tr><th>Wavenumber</th><th>Trans%</th><th>Assignment</th></tr></thead><tbody>${(i2.major_peaks||[]).map(p=>`<tr><td class="wn">${p.wavenumber} cm‚Åª¬π</td><td class="tr">${p.transmittance}%</td><td class="asgn">${p.assignment}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">No peaks</td></tr>'}</tbody></table></div></div>
    </div>
    <div style="margin-top:16px">
      <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--green);margin-bottom:7px">Matching Peaks</div>
      <div class="table-wrap"><table><thead><tr><th>Spectrum 1 (cm‚Åª¬π)</th><th>Spectrum 2 (cm‚Åª¬π)</th><th>Œî Diff</th><th>Note</th></tr></thead><tbody>${(c.matching_peaks||[]).map(p=>`<tr class="match-tr"><td class="wn">${p.wavenumber_img1}</td><td class="wn">${p.wavenumber_img2}</td><td class="tr">${p.difference}</td><td class="asgn">${p.note}</td></tr>`).join('')||'<tr><td colspan="4" style="color:var(--mid)">None</td></tr>'}</tbody></table></div>
      <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--red);margin:12px 0 7px">Unique Peaks</div>
      <div class="table-wrap"><table><thead><tr><th>Wavenumber</th><th>Present In</th><th>Note</th></tr></thead><tbody>${(c.non_matching_peaks||[]).map(p=>`<tr class="nomatch-tr"><td class="wn">${p.wavenumber}</td><td style="color:var(--amber);font-family:var(--mono);font-size:12px">${p.present_in}</td><td class="asgn">${p.note}</td></tr>`).join('')||'<tr><td colspan="3" style="color:var(--mid)">None</td></tr>'}</tbody></table></div>
    </div>
  </div>
  <div class="detail-pane" id="${uid}_comparison">
    <div class="sim-bar-wrap">
      <div class="sim-bar-top"><span style="font-size:13px;color:var(--ink3)">Similarity Score</span><span class="pct">${c.similarity_score||0}%</span></div>
      <div class="sim-bar"><div class="sim-fill" style="width:${c.similarity_score||0}%"></div></div>
    </div>
    <div class="comp-grid">
      <div class="comp-box"><div class="box-label">100% Accuracy</div><p style="font-weight:600;color:${c.accuracy_100_percent?'var(--green)':'var(--red)'};margin-bottom:5px">${c.accuracy_100_percent?'‚úì Perfect Match':'‚úó Not Identical'}</p><p style="font-size:13px">${c.accuracy_explanation||''}</p></div>
      <div class="comp-box"><div class="box-label">Functional Groups</div><p>${c.functional_groups_comparison||'‚Äî'}</p></div>
    </div>
    <div class="sim-lists">
      <div><div class="sim-list-title pos">Similarities</div><ul class="sim-list pos">${(c.similarities||[]).map(s=>`<li>${s}</li>`).join('')||'<li>None</li>'}</ul></div>
      <div><div class="sim-list-title neg">Differences</div><ul class="sim-list neg">${(c.differences||[]).map(d=>`<li>${d}</li>`).join('')||'<li>None</li>'}</ul></div>
    </div>
    <div class="conclusion-box"><div class="clabel">Conclusion</div>${c.conclusion||'‚Äî'}</div>
  </div>
  <div class="detail-pane" id="${uid}_curve">
    <div style="background:var(--off);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:14px;font-size:13px;color:var(--ink2);line-height:1.7">
      <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:7px">Trough & Crest Comparison</div>
      ${c.trough_crest_comparison||'‚Äî'}
    </div>
    <div class="comp-grid" style="margin-bottom:14px">
      <div class="comp-box"><div class="box-label">Spectrum 1 Pattern</div><p>${c.curve_up_down_analysis?.image1_pattern||'‚Äî'}</p></div>
      <div class="comp-box"><div class="box-label">Spectrum 2 Pattern</div><p>${c.curve_up_down_analysis?.image2_pattern||'‚Äî'}</p></div>
    </div>
    <div style="background:var(--teal-light);border:1px solid rgba(26,107,94,.2);border-radius:8px;padding:12px 14px;font-size:13px;color:var(--ink2);line-height:1.6;margin-bottom:14px">
      <strong style="color:var(--teal)">Pattern Similarity: </strong>${c.curve_up_down_analysis?.how_similar||'‚Äî'}
    </div>
    <div class="col2">
      ${buildRegions(i1,'Spectrum 1 Regions')}
      ${buildRegions(i2,'Spectrum 2 Regions')}
    </div>
  </div>`;
}

function buildCompBlock(img,label){
  const confColor=img.identification_confidence==='High'?'var(--green)':img.identification_confidence==='Medium'?'var(--amber)':'var(--red)';
  const fgs=Array.isArray(img.functional_groups)?img.functional_groups:[];
  return `<div class="info-block">
    <div class="label">${label}</div>
    <div class="compound-big">${img.compound_name||'Unknown'}</div>
    <div class="formula-big">${img.chemical_formula||'‚Äî'}</div>
    <div class="meta-chips">
      ${img.identification_confidence?`<span class="chip" style="color:${confColor};border-color:${confColor}">Confidence: ${img.identification_confidence}</span>`:''}
      ${img.molecular_weight?`<span class="chip">MW: ${img.molecular_weight}</span>`:''}
      ${img.sample_type?`<span class="chip">${img.sample_type}</span>`:''}
    </div>
    ${fgs.length?`<div class="meta-chips">${fgs.map(f=>`<span class="chip" style="background:var(--teal-light);color:var(--teal)">${f}</span>`).join('')}</div>`:''}
    ${img.identification_reasoning?`<div class="reasoning-box"><div class="reasoning-label">üî¨ How AI Identified This Compound</div><div class="reasoning-text">${img.identification_reasoning}</div></div>`:''}
    ${img.possible_alternatives?`<div class="alt-box"><div class="alt-label">Possible Alternatives</div><div class="alt-text">${img.possible_alternatives}</div></div>`:''}
    ${img.smiles?`<div style="font-size:11px;font-family:var(--mono);color:var(--ink3);background:var(--off);padding:6px 8px;border-radius:5px;margin-bottom:8px;word-break:break-all">SMILES: ${img.smiles}</div>`:''}
    <div class="curve-text">${img.curve_description||''}</div>
  </div>`;
}

function buildRegions(img,title){
  const r=img.key_regions||{};
  return `<div><div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:8px">${title}</div>
    <div class="regions-wrap">
      <div class="region-card"><div class="region-label">4000‚Äì2500 cm‚Åª¬π</div><div class="region-text">${r['4000_2500']||'‚Äî'}</div></div>
      <div class="region-card"><div class="region-label">2500‚Äì1500 cm‚Åª¬π</div><div class="region-text">${r['2500_1500']||'‚Äî'}</div></div>
      <div class="region-card"><div class="region-label">1500‚Äì500 cm‚Åª¬π (Fingerprint)</div><div class="region-text">${r['1500_500']||'‚Äî'}</div></div>
    </div>
  </div>`;
}

function toggleCard(uid){document.getElementById(uid).classList.toggle('open')}
function switchTab(uid,tab,btn){
  const card=document.getElementById(uid);
  card.querySelectorAll('.dtab').forEach(t=>t.classList.remove('active'));
  card.querySelectorAll('.detail-pane').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`${uid}_${tab}`).classList.add('active');
}

// LIBRARY
async function loadLibrary(){
  const content=document.getElementById('libraryContent');
  content.innerHTML=`<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div>`;
  try{
    const res=await fetch('/library');
    const rows=await res.json();
    const stats=document.getElementById('libStats');
    if(!rows.length){
      stats.innerHTML='';
      content.innerHTML=`<div class="empty-state"><div class="empty-icon">üß™</div><div class="empty-title">Library is empty</div><div class="empty-sub">Run some analyses first ‚Äî every compound identified gets saved here automatically</div></div>`;
      return;
    }
    const unique=new Set(rows.map(r=>r.compound_name)).size;
    stats.innerHTML=`<span class="lib-stat"><strong>${rows.length}</strong> entries</span><span class="lib-stat"><strong>${unique}</strong> unique compounds</span>`;
    content.innerHTML=`<div class="lib-grid">${rows.map(r=>buildLibCard(r)).join('')}</div>`;
  }catch(e){content.innerHTML=`<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Error loading library</div></div>`;}
}

function buildLibCard(r){
  const fgs=r.functional_groups?r.functional_groups.split(',').filter(f=>f.trim()):[];
  const confClass=r.identification_confidence==='High'?'conf-high':r.identification_confidence==='Medium'?'conf-med':'conf-low';
  return `<div class="lib-card">
    <div class="lib-compound">${r.compound_name||'Unknown'}</div>
    <div class="lib-formula">${r.molecular_formula||'‚Äî'}</div>
    ${fgs.length?`<div class="lib-chips">${fgs.slice(0,4).map(f=>`<span class="lib-chip">${f.trim()}</span>`).join('')}</div>`:''}
    <div class="lib-row"><span>Molecular Weight</span><strong>${r.molecular_weight||'‚Äî'}</strong></div>
    <div class="lib-row"><span>SMILES</span><strong style="font-family:var(--mono);font-size:11px;word-break:break-all">${r.smiles||'‚Äî'}</strong></div>
    <div class="lib-row"><span>Sample Type</span><strong>${r.sample_type||'‚Äî'}</strong></div>
    <div class="lib-row"><span>Confidence</span><strong class="${confClass}">${r.identification_confidence||'‚Äî'}</strong></div>
    <div class="lib-row"><span>Source</span><strong>${r.reference_source||'SpectraLens'}</strong></div>
    <div class="lib-row"><span>Date Added</span><strong style="font-family:var(--mono);font-size:11px">${r.date_added||'‚Äî'}</strong></div>
    ${r.identification_reasoning?`<div style="margin-top:10px;font-size:12px;color:var(--ink3);line-height:1.5;border-top:1px solid var(--stone);padding-top:8px">${r.identification_reasoning.substring(0,200)}${r.identification_reasoning.length>200?'...':''}</div>`:''}
  </div>`;
}

// HISTORY
async function loadHistory(){
  const content=document.getElementById('historyContent');
  content.innerHTML=`<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div>`;
  try{
    const res=await fetch('/history');
    const rows=await res.json();
    if(!rows.length){content.innerHTML=`<div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-title">No history yet</div><div class="empty-sub">Run your first analysis</div></div>`;return;}
    const tbody=[...rows].reverse().map(r=>{
      const s=parseInt(r.similarity_score||0);
      const sc=s>=70?'score-h':s>=40?'score-m':'score-l';
      return `<tr><td style="color:var(--ink3);font-family:var(--mono);font-size:11px">${r.timestamp}</td><td><strong>${r.compound1}</strong><br><span style="font-family:var(--mono);font-size:11px;color:var(--teal)">${r.formula1}</span></td><td><strong>${r.compound2}</strong><br><span style="font-family:var(--mono);font-size:11px;color:var(--teal)">${r.formula2}</span></td><td><span class="score-cell ${sc}">${s}%</span></td><td><span class="badge-same ${r.is_same_compound==='True'?'badge-yes':'badge-no'}">${r.is_same_compound==='True'?'Same':'Diff'}</span></td><td><span class="badge-same ${r.accuracy_100_percent==='True'?'badge-yes':'badge-no'}">${r.accuracy_100_percent==='True'?'100%':'No'}</span></td></tr>`;
    }).join('');
    content.innerHTML=`<div class="htable-wrap"><table class="htable"><thead><tr><th>Time</th><th>Compound 1</th><th>Compound 2</th><th>Score</th><th>Same?</th><th>100%?</th></tr></thead><tbody>${tbody}</tbody></table></div><p style="font-size:12px;color:var(--ink3);margin-top:8px;font-family:var(--mono)">${rows.length} total records</p>`;
  }catch(e){content.innerHTML=`<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Could not load</div></div>`;}
}

function showError(msg){const b=document.getElementById('errorBanner');b.textContent=msg;b.style.display='block';}
function hideError(){document.getElementById('errorBanner').style.display='none';}
</script>
</body>
</html>
